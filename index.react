import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, serverTimestamp } from 'firebase/firestore';
import { Search, Plus, Moon, Sun, X, CornerDownLeft, Eye, MessageCircle, GitPullRequest } from 'lucide-react';

// Tailwind CSS is assumed to be available
// For a simple deploy, you can include the script in your public/index.html file:
// <script src="https://cdn.tailwindcss.com"></script>

const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Mapeo para los estados de las tareas
const statusMap = {
Â  'to-do': 'To Do',
Â  'in-progress': 'En Proceso',
Â  'done': 'Completada',
};

// Opciones predefinidas para la fecha de entrega
const dateOptions = [
Â  { label: 'Hoy', value: 0 },
Â  { label: 'MaÃ±ana', value: 1 },
Â  { label: '3 DÃ­as', value: 3 },
Â  { label: '4 DÃ­as', value: 4 },
Â  { label: '5 DÃ­as', value: 5 },
];

function App() {
Â  const [db, setDb] = useState(null);
Â  const [auth, setAuth] = useState(null);
Â  const [userId, setUserId] = useState(null);
Â  const [isAuthReady, setIsAuthReady] = useState(false);
Â  const [projects, setProjects] = useState([]);
Â  const [selectedProjectId, setSelectedProjectId] = useState(null);
Â  const [tasks, setTasks] = useState([]);
Â  const [kanbanData, setKanbanData] = useState({
Â  Â  'to-do': [],
Â  Â  'in-progress': [],
Â  Â  'done': [],
Â  });
Â  const [isModalOpen, setIsModalOpen] = useState(false);
Â  const [newTask, setNewTask] = useState({
Â  Â  title: '',
Â  Â  description: '',
Â  Â  infoAdicional: {
Â  Â  Â  terminal: '',
Â  Â  Â  operacion: '',
Â  Â  Â  consecutivo: '',
Â  Â  Â  cotizacion: '',
Â  Â  Â  monto: '',
Â  Â  },
Â  Â  dueDate: '',
Â  });
Â  const [selectedTask, setSelectedTask] = useState(null);
Â  const [isTaskDetailModalOpen, setIsTaskDetailModalOpen] = useState(false);
Â  const [taskHistory, setTaskHistory] = useState([]);
Â  const [newProjectName, setNewProjectName] = useState('');
Â  const [showProjectModal, setShowProjectModal] = useState(false);
Â  const [currentView, setCurrentView] = useState('dashboard'); // 'dashboard' or 'kanban'
Â  const [showCompletedTasks, setShowCompletedTasks] = useState(true);
Â  const [taskUpdateData, setTaskUpdateData] = useState({ comment: '' });
Â  const [isUpdateModalOpen, setIsUpdateModalOpen] = useState(false);
Â  const [taskToUpdate, setTaskToUpdate] = useState(null);
Â  const [historyModalOpen, setHistoryModalOpen] = useState(false);
Â  const [selectedHistoryItem, setSelectedHistoryItem] = useState(null);
Â  const [isConfirmTaskModalOpen, setIsConfirmTaskModalOpen] = useState(false);
Â  const [taskToConfirm, setTaskToConfirm] = useState(null);
Â  const [isProjectDropdownOpen, setIsProjectDropdownOpen] = useState(false);
Â  const projectDropdownRef = useRef(null);

Â  // Estados y funciones para el avatar
Â  const [userAvatar, setUserAvatar] = useState('ðŸ§‘â€ðŸ’»');
Â  const [showUserInfoModal, setShowUserInfoModal] = useState(false);
Â  const defaultEmojis = ['ðŸ’»', 'ðŸš€', 'ðŸŒŸ', 'ðŸ’¡', 'ðŸ¤–', 'ðŸ‘¾', 'ðŸŒˆ', 'ðŸŽ‰'];

Â  const [darkMode, setDarkMode] = useState(() => {
Â  Â  // Leer la preferencia de localStorage al iniciar
Â  Â  const savedMode = localStorage.getItem('darkMode');
Â  Â  return savedMode === 'true' ? true : false;
Â  });

Â  // --- Novedad: LÃ³gica del Asistente de BÃºsqueda (Clip) ---
Â  const [isAssistantModalOpen, setIsAssistantModalOpen] = useState(false);
Â  const [assistantQuery, setAssistantQuery] = useState('');
Â  const [assistantResponse, setAssistantResponse] = useState('');
Â  const [isAssistantLoading, setIsAssistantLoading] = useState(false);
Â  const [chatHistory, setChatHistory] = useState([]);
Â  const responseRef = useRef(null);
Â  
Â  // --- Novedad: Estado para el menÃº de acciÃ³n flotante ---
Â  const [showFloatingActionMenu, setShowFloatingActionMenu] = useState(false);
Â  
Â  // --- Novedad: Estado para la animaciÃ³n de rebote del botÃ³n Clip ---
Â  const [isBouncing, setIsBouncing] = useState(true);

Â  // useEffect para la animaciÃ³n de rebote del botÃ³n Clip
Â  useEffect(() => {
Â  Â  const timer = setTimeout(() => {
Â  Â  Â  setIsBouncing(false);
Â  Â  }, 3000); // 3 segundos
Â  Â  return () => clearTimeout(timer);
Â  }, []);

Â  const toggleDarkMode = () => {
Â  Â  setDarkMode(prevMode => {
Â  Â  Â  const newMode = !prevMode;
Â  Â  Â  localStorage.setItem('darkMode', newMode);
Â  Â  Â  return newMode;
Â  Â  });
Â  };

Â  useEffect(() => {
Â  Â  if (responseRef.current) {
Â  Â  Â  responseRef.current.scrollIntoView({ behavior: 'smooth' });
Â  Â  }
Â  }, [chatHistory]);
Â  
Â  // FunciÃ³n para manejar la bÃºsqueda del asistente
Â  const handleAssistantSearch = async (e) => {
Â  Â  e.preventDefault();
Â  Â  if (!assistantQuery.trim()) return;

Â  Â  setIsAssistantLoading(true);
Â  Â  setAssistantResponse('');
Â  Â  setChatHistory(prev => [...prev, { role: 'user', text: assistantQuery }]);
Â  Â  
Â  Â  // Guardamos la consulta del usuario antes de enviarla
Â  Â  const userPrompt = assistantQuery;
Â  Â  setAssistantQuery('');

Â  Â  // Preparamos el contexto para el modelo de IA
Â  Â  const projectsList = projects.map(p => ({
Â  Â  Â  id: p.id,
Â  Â  Â  name: p.name,
Â  Â  }));
Â  Â  const tasksList = tasks.map(t => ({
Â  Â  Â  id: t.id,
Â  Â  Â  title: t.title,
Â  Â  Â  description: t.description,
Â  Â  Â  status: t.status,
Â  Â  Â  dueDate: t.dueDate,
Â  Â  Â  projectName: t.projectName,
Â  Â  Â  infoAdicional: t.infoAdicional,
Â  Â  }));
Â  Â  
Â  Â  // Le decimos al modelo que actÃºe como un asistente de bÃºsqueda.
Â  Â  const prompt = `ActÃºa como un asistente de bÃºsqueda para una aplicaciÃ³n de gestiÃ³n de proyectos. El usuario te harÃ¡ preguntas sobre sus proyectos y tareas. Proporciona respuestas concisas y directas basadas en la informaciÃ³n que te darÃ©.
Â  Â  
Â  Â  Tus datos disponibles son los siguientes (en formato JSON):
Â  Â  
Â  Â  - Proyectos: ${JSON.stringify(projectsList)}
Â  Â  - Tareas: ${JSON.stringify(tasksList)}

Â  Â  Pregunta del usuario: "${userPrompt}"
Â  Â  `;

Â  Â  const apiHistory = [{ role: "user", parts: [{ text: prompt }] }];
Â  Â  const payload = { contents: apiHistory };
Â  Â  const apiKey = "";
Â  Â  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

Â  Â  try {
Â  Â  Â  const response = await fetch(apiUrl, {
Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  });
Â  Â  Â  const result = await response.json();

Â  Â  Â  if (result.candidates && result.candidates.length > 0) {
Â  Â  Â  Â  const text = result.candidates[0].content.parts[0].text;
Â  Â  Â  Â  setAssistantResponse(text);
Â  Â  Â  Â  setChatHistory(prev => [...prev, { role: 'assistant', text: text }]);
Â  Â  Â  } else {
Â  Â  Â  Â  setAssistantResponse("No pude encontrar una respuesta con la informaciÃ³n disponible. Intenta una pregunta diferente.");
Â  Â  Â  Â  setChatHistory(prev => [...prev, { role: 'assistant', text: "No pude encontrar una respuesta con la informaciÃ³n disponible. Intenta una pregunta diferente." }]);
Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error al llamar a la API de Gemini:", error);
Â  Â  Â  setAssistantResponse("OcurriÃ³ un error al procesar tu solicitud. IntÃ©ntalo de nuevo mÃ¡s tarde.");
Â  Â  Â  setChatHistory(prev => [...prev, { role: 'assistant', text: "OcurriÃ³ un error al procesar tu solicitud. IntÃ©ntalo de nuevo mÃ¡s tarde." }]);
Â  Â  } finally {
Â  Â  Â  setIsAssistantLoading(false);
Â  Â  }
Â  };

Â  useEffect(() => {
Â  Â  // Inicializar Firebase
Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const firestore = getFirestore(app);
Â  Â  const authentication = getAuth(app);
Â  Â  setDb(firestore);
Â  Â  setAuth(authentication);

Â  Â  // Iniciar sesiÃ³n con token personalizado o de forma anÃ³nima
Â  Â  onAuthStateChanged(authentication, async (user) => {
Â  Â  Â  if (user) {
Â  Â  Â  Â  setUserId(user.uid);
Â  Â  Â  } else {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  if (initialAuthToken) {
Â  Â  Â  Â  Â  Â  await signInWithCustomToken(authentication, initialAuthToken);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  await signInAnonymously(authentication);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error("Error de autenticaciÃ³n de Firebase:", error);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  setIsAuthReady(true);
Â  Â  });
Â  }, []);

Â  useEffect(() => {
Â  Â  if (db && userId) {
Â  Â  Â  const projectsRef = collection(db, 'artifacts', appId, 'users', userId, 'projects');
Â  Â  Â  const projectsUnsub = onSnapshot(projectsRef, (snapshot) => {
Â  Â  Â  Â  const fetchedProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  setProjects(fetchedProjects);
Â  Â  Â  Â  if (fetchedProjects.length > 0 && !selectedProjectId) {
Â  Â  Â  Â  Â  setSelectedProjectId(fetchedProjects[0].id);
Â  Â  Â  Â  }
Â  Â  Â  }, (error) => {
Â  Â  Â  Â  console.error("Error al obtener proyectos:", error);
Â  Â  Â  });

Â  Â  Â  const historyRef = collection(db, 'artifacts', appId, 'users', userId, 'taskHistory');
Â  Â  Â  const historyUnsub = onSnapshot(historyRef, (snapshot) => {
Â  Â  Â  Â  const fetchedHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  setTaskHistory(fetchedHistory.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate()));
Â  Â  Â  }, (error) => {
Â  Â  Â  Â  console.error("Error al obtener el historial de tareas:", error);
Â  Â  Â  });
Â  Â  Â  
Â  Â  Â  const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'userData', 'profile');
Â  Â  Â  const userUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
Â  Â  Â  Â  Â  if (docSnap.exists() && docSnap.data().avatar) {
Â  Â  Â  Â  Â  Â  Â  setUserAvatar(docSnap.data().avatar);
Â  Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  return () => {
Â  Â  Â  Â  projectsUnsub();
Â  Â  Â  Â  historyUnsub();
Â  Â  Â  Â  userUnsubscribe();
Â  Â  Â  };
Â  Â  }
Â  }, [db, userId, appId, selectedProjectId]);

Â  useEffect(() => {
Â  Â  if (db && userId && selectedProjectId) {
Â  Â  Â  const tasksRef = collection(db, 'artifacts', appId, 'users', userId, 'tasks');
Â  Â  Â  const tasksQuery = query(tasksRef, where('projectId', '==', selectedProjectId));
Â  Â  Â  const tasksUnsub = onSnapshot(tasksQuery, (snapshot) => {
Â  Â  Â  Â  const fetchedTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  setTasks(fetchedTasks);
Â  Â  Â  Â  organizeTasksForKanban(fetchedTasks);
Â  Â  Â  }, (error) => {
Â  Â  Â  Â  console.error("Error al obtener tareas:", error);
Â  Â  Â  });

Â  Â  Â  return tasksUnsub;
Â  Â  }
Â  }, [db, userId, appId, selectedProjectId]);

Â  // Manejar clics fuera del dropdown
Â  useEffect(() => {
Â  Â  const handleClickOutside = (event) => {
Â  Â  Â  if (projectDropdownRef.current && !projectDropdownRef.current.contains(event.target)) {
Â  Â  Â  Â  setIsProjectDropdownOpen(false);
Â  Â  Â  }
Â  Â  };
Â  Â  document.addEventListener("mousedown", handleClickOutside);
Â  Â  return () => {
Â  Â  Â  document.removeEventListener("mousedown", handleClickOutside);
Â  Â  };
Â  }, [projectDropdownRef]);


Â  const organizeTasksForKanban = (tasks) => {
Â  Â  const newKanbanData = {
Â  Â  Â  'to-do': tasks.filter(task => task.status === 'to-do'),
Â  Â  Â  'in-progress': tasks.filter(task => task.status === 'in-progress'),
Â  Â  Â  'done': tasks.filter(task => task.status === 'done'),
Â  Â  };
Â  Â  setKanbanData(newKanbanData);
Â  };

Â  const handleCreateProject = async () => {
Â  Â  if (!newProjectName.trim() || !db || !userId) {
Â  Â  Â  console.error("Falta el nombre del proyecto, db o userId.");
Â  Â  Â  return;
Â  Â  }
Â  Â  try {
Â  Â  Â  const projectsRef = collection(db, 'artifacts', appId, 'users', userId, 'projects');
Â  Â  Â  await addDoc(projectsRef, {
Â  Â  Â  Â  name: newProjectName,
Â  Â  Â  Â  createdAt: new Date(),
Â  Â  Â  Â  userId: userId,
Â  Â  Â  });
Â  Â  Â  setNewProjectName('');
Â  Â  Â  setShowProjectModal(false);
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error al crear el proyecto:", error);
Â  Â  }
Â  };

Â  const handlePreCreateTask = (e) => {
Â  Â  e.preventDefault();
Â  Â  if (!newTask.title.trim() || !selectedProjectId) {
Â  Â  Â  return;
Â  Â  }
Â  Â  // Abrir el modal de confirmaciÃ³n con los datos de la tarea
Â  Â  setTaskToConfirm(newTask);
Â  Â  setIsConfirmTaskModalOpen(true);
Â  };

Â  const handleConfirmCreateTask = async () => {
Â  Â  if (!taskToConfirm || !db || !userId || !selectedProjectId) {
Â  Â  Â  return;
Â  Â  }

Â  Â  try {
Â  Â  Â  const projectsRef = collection(db, 'artifacts', appId, 'users', userId, 'projects');
Â  Â  Â  const projectDoc = await getDoc(doc(projectsRef, selectedProjectId));
Â  Â  Â  const projectName = projectDoc.exists() ? projectDoc.data().name : 'N/A';
Â  Â  Â  
Â  Â  Â  const tasksRef = collection(db, 'artifacts', appId, 'users', userId, 'tasks');
Â  Â  Â  const taskPayload = {
Â  Â  Â  Â  ...taskToConfirm,
Â  Â  Â  Â  status: 'to-do',
Â  Â  Â  Â  projectId: selectedProjectId,
Â  Â  Â  Â  projectName: projectName, // AÃ±adir nombre del proyecto
Â  Â  Â  Â  createdAt: new Date(),
Â  Â  Â  Â  userId: userId,
Â  Â  Â  Â  infoAdicional: {
Â  Â  Â  Â  Â  ...taskToConfirm.infoAdicional,
Â  Â  Â  Â  Â  monto: parseFloat(taskToConfirm.infoAdicional.monto.replace(/,/g, '') || 0),
Â  Â  Â  Â  },
Â  Â  Â  Â  history: [{
Â  Â  Â  Â  Â  status: 'to-do',
Â  Â  Â  Â  Â  timestamp: new Date(),
Â  Â  Â  Â  Â  change: 'Tarea creada',
Â  Â  Â  Â  Â  comment: '',
Â  Â  Â  Â  }],
Â  Â  Â  };
Â  Â  Â  await addDoc(tasksRef, taskPayload);
Â  Â  Â  setNewTask({
Â  Â  Â  Â  title: '',
Â  Â  Â  Â  description: '',
Â  Â  Â  Â  infoAdicional: { terminal: '', operacion: '', consecutivo: '', cotizacion: '', monto: '' },
Â  Â  Â  Â  dueDate: '',
Â  Â  Â  });
Â  Â  Â  setIsModalOpen(false);
Â  Â  Â  setIsConfirmTaskModalOpen(false);
Â  Â  Â  setTaskToConfirm(null);
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error al crear la tarea:", error);
Â  Â  }
Â  };

Â  const handleConfirmUpdate = async () => {
Â  Â  if (taskToUpdate) {
Â  Â  Â  await handleUpdateTaskStatus(taskToUpdate.taskId, taskToUpdate.newStatus, taskUpdateData.comment);
Â  Â  Â  closeModal();
Â  Â  }
Â  };

Â  const handleUpdateTaskStatus = async (taskId, newStatus, comment) => {
Â  Â  if (!db || !userId) return;

Â  Â  try {
Â  Â  Â  const taskDocRef = doc(db, 'artifacts', appId, 'users', userId, 'tasks', taskId);
Â  Â  Â  const taskSnapshot = await getDoc(taskDocRef);
Â  Â  Â  if (!taskSnapshot.exists()) return;
Â  Â  Â  const currentTask = taskSnapshot.data();

Â  Â  Â  const newHistoryEntry = {
Â  Â  Â  Â  status: newStatus,
Â  Â  Â  Â  timestamp: new Date(),
Â  Â  Â  Â  change: `Estado cambiado de '${statusMap[currentTask.status]}' a '${statusMap[newStatus]}'`,
Â  Â  Â  Â  comment: comment,
Â  Â  Â  };

Â  Â  Â  await updateDoc(taskDocRef, {
Â  Â  Â  Â  status: newStatus,
Â  Â  Â  Â  history: [...currentTask.history, newHistoryEntry],
Â  Â  Â  });

Â  Â  Â  const historyRef = collection(db, 'artifacts', appId, 'users', userId, 'taskHistory');
Â  Â  Â  await addDoc(historyRef, {
Â  Â  Â  Â  taskId: taskId,
Â  Â  Â  Â  taskTitle: currentTask.title,
Â  Â  Â  Â  fromStatus: currentTask.status,
Â  Â  Â  Â  toStatus: newStatus,
Â  Â  Â  Â  timestamp: new Date(),
Â  Â  Â  Â  userId: userId,
Â  Â  Â  Â  projectName: currentTask.projectName,
Â  Â  Â  });

Â  Â  } catch (error) {
Â  Â  Â  console.error("Error al actualizar el estado de la tarea:", error);
Â  Â  }
Â  };

Â  const handleDragStart = (e, taskId) => {
Â  Â  e.dataTransfer.setData("taskId", taskId);
Â  };

Â  const handleDragOver = (e) => {
Â  Â  e.preventDefault();
Â  };

Â  const handleDrop = (e, status) => {
Â  Â  e.preventDefault();
Â  Â  const taskId = e.dataTransfer.getData("taskId");
Â  Â  const task = tasks.find(t => t.id === taskId);
Â  Â  if (task && task.status !== status) {
Â  Â  Â  setTaskToUpdate({ taskId, newStatus: status });
Â  Â  Â  setIsUpdateModalOpen(true);
Â  Â  }
Â  };

Â  const handleDateChange = (daysToAdd) => {
Â  Â  const date = new Date();
Â  Â  date.setDate(date.getDate() + daysToAdd);
Â  Â  setNewTask(prev => ({ ...prev, dueDate: date.toISOString().split('T')[0] }));
Â  };

Â  const handleCustomDateChange = (e) => {
Â  Â  setNewTask(prev => ({ ...prev, dueDate: e.target.value }));
Â  };

Â  const handleMontoChange = (e) => {
Â  Â  const rawValue = e.target.value.replace(/[^0-9.]/g, ''); // Permite solo nÃºmeros y punto
Â  Â  const formattedValue = new Intl.NumberFormat('es-MX').format(rawValue);
Â  Â  setNewTask(prev => ({
Â  Â  Â  ...prev,
Â  Â  Â  infoAdicional: { ...prev.infoAdicional, monto: formattedValue }
Â  Â  }));
Â  };

Â  const openTaskDetailModal = (task) => {
Â  Â  setSelectedTask(task);
Â  Â  setIsTaskDetailModalOpen(true);
Â  };

Â  const openHistoryAuditModal = (historyItem) => {
Â  Â  const taskDetails = tasks.find(t => t.id === historyItem.taskId);
Â  Â  if (taskDetails) {
Â  Â  Â  setSelectedHistoryItem({
Â  Â  Â  Â  ...historyItem,
Â  Â  Â  Â  fullHistory: taskDetails.history,
Â  Â  Â  });
Â  Â  Â  setHistoryModalOpen(true);
Â  Â  }
Â  };

Â  const closeModal = () => {
Â  Â  setIsModalOpen(false);
Â  Â  setIsTaskDetailModalOpen(false);
Â  Â  setShowProjectModal(false);
Â  Â  setIsUpdateModalOpen(false);
Â  Â  setHistoryModalOpen(false);
Â  Â  setIsConfirmTaskModalOpen(false);
Â  Â  setTaskToConfirm(null);
Â  Â  setShowUserInfoModal(false);
Â  Â  setIsAssistantModalOpen(false);
Â  Â  // --- Novedad: Cerrar el menÃº flotante al cerrar cualquier modal ---
Â  Â  setShowFloatingActionMenu(false);
Â  Â  setNewTask({
Â  Â  Â  title: '',
Â  Â  Â  description: '',
Â  Â  Â  infoAdicional: { terminal: '', operacion: '', consecutivo: '', cotizacion: '', monto: '' },
Â  Â  Â  dueDate: '',
Â  Â  });
Â  Â  setTaskUpdateData({ comment: '' });
Â  };
Â  
Â  // Funciones para el avatar
Â  const handleUpdateAvatar = async (newAvatar) => {
Â  Â  if (!db || !userId) return;

Â  Â  const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'userData', 'profile');
Â  Â  try {
Â  Â  Â  Â  await setDoc(userDocRef, { avatar: newAvatar }, { merge: true });
Â  Â  Â  Â  setUserAvatar(newAvatar);
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error al actualizar el avatar:', error);
Â  Â  }
Â  };

Â  const handleFileChange = (e) => {
Â  Â  const file = e.target.files[0];
Â  Â  if (file) {
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onloadend = () => {
Â  Â  Â  Â  Â  Â  handleUpdateAvatar(reader.result);
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  }
Â  };

Â  const getDueDateClass = (dueDate) => {
Â  Â  if (!dueDate) return '';
Â  Â  const now = new Date();
Â  Â  const due = new Date(dueDate);
Â  Â  const diffTime = due - now;
Â  Â  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
Â  Â  if (diffDays <= 1) return 'bg-red-500';
Â  Â  if (diffDays <= 3) return 'bg-yellow-500';
Â  Â  // Se ha cambiado de 'bg-[#0038A6]' a 'bg-sky-600' para un tono mÃ¡s suave
Â  Â  return 'bg-sky-600'; 
Â  };

Â  const renderKanbanColumn = (status) => (
Â  Â  <div
Â  Â  Â  key={status}
Â  Â  Â  className="bg-slate-50 dark:bg-slate-800 p-4 rounded-lg shadow-inner flex-1 flex flex-col gap-4 min-h-[300px]"
Â  Â  Â  onDragOver={handleDragOver}
Â  Â  Â  onDrop={(e) => handleDrop(e, status)}
Â  Â  >
Â  Â  Â  <h3 className="text-lg font-semibold text-slate-800 dark:text-slate-200 border-b pb-2 border-slate-200 dark:border-slate-700">{statusMap[status]}</h3>
Â  Â  Â  {kanbanData[status]?.map(task => {
Â  Â  Â  Â  if (!showCompletedTasks && task.status === 'done') return null;
Â  Â  Â  Â  return (
Â  Â  Â  Â  Â  <div
Â  Â  Â  Â  Â  Â  key={task.id}
Â  Â  Â  Â  Â  Â  className="bg-white dark:bg-slate-700 p-4 rounded-md shadow-md cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors duration-200"
Â  Â  Â  Â  Â  Â  draggable="true"
Â  Â  Â  Â  Â  Â  onDragStart={(e) => handleDragStart(e, task.id)}
Â  Â  Â  Â  Â  Â  onClick={() => openTaskDetailModal(task)}
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  <div className="flex justify-between items-center mb-2">
Â  Â  Â  Â  Â  Â  Â  <p className="font-medium text-slate-800 dark:text-slate-100">{task.title}</p>
Â  Â  Â  Â  Â  Â  Â  {task.dueDate && (
Â  Â  Â  Â  Â  Â  Â  Â  <span className={`text-xs font-semibold text-white ${getDueDateClass(task.dueDate)} rounded-full px-2 py-1`}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  {new Date(task.dueDate).toLocaleDateString()}
Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p className="text-sm text-slate-500 dark:text-slate-400">{task.description}</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  );
Â  Â  Â  })}
Â  Â  </div>
Â  );

Â  const getUpcomingTasks = () => {
Â  Â  const now = new Date();
Â  Â  return tasks.filter(task => {
Â  Â  Â  if (task.status === 'done') return false;
Â  Â  Â  const dueDate = new Date(task.dueDate);
Â  Â  Â  const diffTime = dueDate.getTime() - now.getTime();
Â  Â  Â  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
Â  Â  Â  return diffDays <= 7 && diffDays >= 0;
Â  Â  }).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
Â  };

Â  const totalTasks = tasks.length;
Â  const tasksToDo = tasks.filter(t => t.status === 'to-do').length;
Â  const tasksInProgress = tasks.filter(t => t.status === 'in-progress').length;
Â  const tasksDone = tasks.filter(t => t.status === 'done').length;
Â  const upcomingTasks = getUpcomingTasks();

Â  if (!isAuthReady) {
Â  Â  return (
Â  Â  Â  <div className="flex items-center justify-center min-h-screen bg-slate-50 dark:bg-slate-900">
Â  Â  Â  Â  <div className="text-center text-slate-500 dark:text-slate-400">Cargando aplicaciÃ³n...</div>
Â  Â  Â  </div>
Â  Â  );
Â  }

Â  const selectedProject = projects.find(p => p.id === selectedProjectId);

Â  const dashboardContent = (
Â  Â  <div className="p-6">
Â  Â  Â  <div className="flex flex-col md:flex-row md:items-center justify-between mb-6">
Â  Â  Â  Â  <div className="relative" ref={projectDropdownRef}>
Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  onClick={() => setIsProjectDropdownOpen(!isProjectDropdownOpen)}
Â  Â  Â  Â  Â  Â  className="flex items-center gap-2 text-3xl font-bold text-slate-900 dark:text-white mb-4 md:mb-0 bg-white dark:bg-slate-800 p-2 rounded-lg shadow-sm hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Dashboard: <span className="text-sky-600 dark:text-white">{selectedProject ? selectedProject.name : 'Seleccionar Proyecto'}</span>
Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 transform transition-transform ${isProjectDropdownOpen ? 'rotate-180' : 'rotate-0'} text-slate-700 dark:text-slate-300`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
Â  Â  Â  Â  Â  Â  Â  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  {isProjectDropdownOpen && (
Â  Â  Â  Â  Â  Â  <div className="absolute top-full left-0 mt-2 w-64 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-md shadow-lg z-20">
Â  Â  Â  Â  Â  Â  Â  <div className="py-1">
Â  Â  Â  Â  Â  Â  Â  Â  {projects.map(project => (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  key={project.id}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onClick={() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setSelectedProjectId(project.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setIsProjectDropdownOpen(false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  className="block w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {project.name}
Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
Â  Â  Â  Â  Â  <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-300">Total de Tareas</h3>
Â  Â  Â  Â  Â  {/* Se ha cambiado de 'text-[#0038A6]' a 'text-sky-600' */}
Â  Â  Â  Â  Â  <p className="text-4xl font-bold text-sky-600">{totalTasks}</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
Â  Â  Â  Â  Â  <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-300">Pendientes</h3>
Â  Â  Â  Â  Â  <p className="text-4xl font-bold text-slate-800 dark:text-slate-100">{tasksToDo}</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
Â  Â  Â  Â  Â  <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-300">En Proceso</h3>
Â  Â  Â  Â  Â  <p className="text-4xl font-bold text-yellow-600">{tasksInProgress}</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
Â  Â  Â  Â  Â  <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-300">Completadas</h3>
Â  Â  Â  Â  Â  <p className="text-4xl font-bold text-green-600">{tasksDone}</p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
Â  Â  Â  Â  Â  <div className="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  <h3 className="text-lg font-bold text-slate-800 dark:text-slate-100">PrÃ³ximas Tareas</h3>
Â  Â  Â  Â  Â  Â  {/* Se ha cambiado de 'bg-[#0038A6]' a 'bg-sky-600' */}
Â  Â  Â  Â  Â  Â  <span className="text-sm font-medium text-white bg-sky-600 rounded-full px-3 py-1">
Â  Â  Â  Â  Â  Â  Â  {upcomingTasks.length}
Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  {upcomingTasks.length > 0 ? (
Â  Â  Â  Â  Â  Â  <ul className="space-y-4">
Â  Â  Â  Â  Â  Â  Â  {upcomingTasks.map(task => (
Â  Â  Â  Â  Â  Â  Â  Â  <li key={task.id} className="border-l-4 border-sky-600 pl-4 py-2 bg-slate-50 dark:bg-slate-700 rounded-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p className="font-semibold text-slate-700 dark:text-slate-200">{task.title}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p className="text-sm text-slate-500 dark:text-slate-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Fecha de entrega: {new Date(task.dueDate).toLocaleDateString()}
Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  <p className="text-slate-500 dark:text-slate-400">No hay tareas prÃ³ximas a vencer.</p>
Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
Â  Â  Â  Â  Â  <h3 className="text-lg font-bold text-slate-800 dark:text-slate-100 mb-4">Historial Reciente</h3>
Â  Â  Â  Â  Â  <ul className="space-y-2">
Â  Â  Â  Â  Â  Â  {taskHistory.slice(0, 6).map((historyItem, index) => (
Â  Â  Â  Â  Â  Â  Â  <li key={index} className="border-b dark:border-slate-700 pb-2 last:border-b-0">
Â  Â  Â  Â  Â  Â  Â  Â  <p className="text-sm font-medium text-slate-800 dark:text-slate-100">{historyItem.taskTitle}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p className="text-xs text-slate-500 dark:text-slate-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  {/* Se ha cambiado de 'text-[#0038A6]' a 'text-sky-600' */}
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span className="font-semibold text-sky-600">{historyItem.projectName}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  : {historyItem.change}
Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  Â  onClick={() => openHistoryAuditModal(historyItem)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  className="mt-1 text-xs text-sky-600 hover:text-sky-700 font-medium"
Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Ver AuditorÃ­a
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  );

Â  const kanbanContent = (
Â  Â  <div className="flex flex-col lg:flex-row p-6 gap-6">
Â  Â  Â  <aside className="w-full lg:w-1/4">
Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md mb-6">
Â  Â  Â  Â  Â  <h2 className="text-xl font-bold mb-4 text-slate-800 dark:text-slate-100">Proyectos</h2>
Â  Â  Â  Â  Â  <div className="flex flex-col gap-2">
Â  Â  Â  Â  Â  Â  {projects.map(project => (
Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  key={project.id}
Â  Â  Â  Â  Â  Â  Â  Â  onClick={() => setSelectedProjectId(project.id)}
Â  Â  Â  Â  Â  Â  Â  Â  // Se ha cambiado de 'bg-[#0038A6]' a 'bg-sky-600'
Â  Â  Â  Â  Â  Â  Â  Â  className={`text-left p-3 rounded-lg transition-colors duration-200 ${selectedProjectId === project.id ? 'bg-sky-600 text-white shadow-md' : 'bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'}`}
Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  {project.name}
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md">
Â  Â  Â  Â  Â  <h2 className="text-xl font-bold mb-4 text-slate-800 dark:text-slate-100">Historial de Tareas</h2>
Â  Â  Â  Â  Â  <div className="flex flex-col gap-2 max-h-96 overflow-y-auto">
Â  Â  Â  Â  Â  Â  {taskHistory.length > 0 ? (
Â  Â  Â  Â  Â  Â  Â  taskHistory.slice(0, 6).map((historyItem, index) => (
Â  Â  Â  Â  Â  Â  Â  Â  <div key={index} className="border-b dark:border-slate-700 pb-2 last:border-b-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p className="text-sm font-medium text-slate-800 dark:text-slate-100">{historyItem.taskTitle}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p className="text-xs text-slate-500 dark:text-slate-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {/* Se ha cambiado de 'text-[#0038A6]' a 'text-sky-600' */}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span className="font-semibold text-sky-600">{historyItem.projectName}</span>: {historyItem.change} - {new Date(historyItem.timestamp.seconds * 1000).toLocaleString()}
Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onClick={() => openHistoryAuditModal(historyItem)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  className="mt-1 text-xs text-sky-600 hover:text-sky-700 font-medium"
Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Ver AuditorÃ­a
Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  ))
Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  <p className="text-slate-500 dark:text-slate-400 text-sm">No hay historial.</p>
Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </aside>

Â  Â  Â  <main className="w-full lg:w-3/4">
Â  Â  Â  Â  {selectedProject ? (
Â  Â  Â  Â  Â  <>
Â  Â  Â  Â  Â  Â  <div className="flex justify-between items-center mb-6">
Â  Â  Â  Â  Â  Â  Â  <h2 className="text-3xl font-bold text-slate-900 dark:text-white">{selectedProject.name}</h2>
Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  onClick={() => setShowCompletedTasks(!showCompletedTasks)}
Â  Â  Â  Â  Â  Â  Â  Â  className="bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-semibold py-2 px-4 rounded-full hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors"
Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  {showCompletedTasks ? 'Ocultar Completadas' : 'Mostrar Completadas'}
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
Â  Â  Â  Â  Â  Â  Â  {Object.keys(statusMap).map(renderKanbanColumn)}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </>
Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  <div className="flex items-center justify-center p-10 bg-white dark:bg-slate-800 rounded-lg shadow-md">
Â  Â  Â  Â  Â  Â  <p className="text-lg text-slate-500 dark:text-slate-400">
Â  Â  Â  Â  Â  Â  Â  Selecciona un proyecto o crea uno nuevo para empezar.
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  )}
Â  Â  Â  </main>
Â  Â  </div>
Â  );

Â  return (
Â  Â  <div className={`min-h-screen font-sans ${darkMode ? 'dark bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-800'}`}>
Â  Â  Â  {/* Header */}
Â  Â  Â  <header className="p-4 bg-white dark:bg-slate-800 shadow-sm flex items-center justify-between sticky top-0 z-10">
Â  Â  Â  Â  {/* Se ha cambiado de 'text-[#0038A6]' a 'text-sky-600' */}
Â  Â  Â  Â  <h1 className="text-2xl font-bold text-sky-600 dark:text-white">COREM-Tasks</h1>
Â  Â  Â  Â  <nav className="flex items-center gap-4">
Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  onClick={() => setCurrentView('dashboard')}
Â  Â  Â  Â  Â  Â  // Se ha cambiado de 'bg-[#0038A6]' a 'bg-sky-600'
Â  Â  Â  Â  Â  Â  className={`px-4 py-2 rounded-full font-semibold transition-colors ${currentView === 'dashboard' ? 'bg-sky-600 text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'}`}
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Inicio
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  onClick={() => setCurrentView('kanban')}
Â  Â  Â  Â  Â  Â  // Se ha cambiado de 'bg-[#0038A6]' a 'bg-sky-600'
Â  Â  Â  Â  Â  Â  className={`px-4 py-2 rounded-full font-semibold transition-colors ${currentView === 'kanban' ? 'bg-sky-600 text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'}`}
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Kanban
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </nav>
Â  Â  Â  Â  <div className="flex items-center gap-4">
Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  onClick={toggleDarkMode}
Â  Â  Â  Â  Â  Â  className="p-2 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  {darkMode ? (
Â  Â  Â  Â  Â  Â  Â  <Sun className="h-6 w-6" />
Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  <Moon className="h-6 w-6" />
Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  onClick={() => setShowUserInfoModal(true)}
Â  Â  Â  Â  Â  Â  className="w-10 h-10 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-2xl"
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  {userAvatar}
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </header>

Â  Â  Â  {/* Main Content */}
Â  Â  Â  <div className="flex-grow p-4 md:p-6">
Â  Â  Â  Â  {currentView === 'dashboard' ? dashboardContent : kanbanContent}
Â  Â  Â  </div>

Â  Â  Â  {/* Floating Action Button - Asistente de BÃºsqueda */}
Â  Â  Â  <div className="fixed bottom-6 right-6 z-50">
Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  onClick={() => setIsAssistantModalOpen(true)}
Â  Â  Â  Â  Â  className={`
Â  Â  Â  Â  Â  Â  p-4 rounded-full text-white shadow-lg transition-transform duration-300
Â  Â  Â  Â  Â  Â  bg-sky-600 hover:bg-sky-700
Â  Â  Â  Â  Â  Â  ${isBouncing ? 'animate-bounce' : ''}
Â  Â  Â  Â  Â  `}
Â  Â  Â  Â  Â  aria-label="Abrir asistente de bÃºsqueda"
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  <Search className="h-6 w-6" />
Â  Â  Â  Â  </button>
Â  Â  Â  </div>
Â  Â  Â  
Â  Â  Â  {/* Floating Action Button - MenÃº de creaciÃ³n */}
Â  Â  Â  <div className="fixed bottom-6 left-6 z-50">
Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  onClick={() => setShowFloatingActionMenu(!showFloatingActionMenu)}
Â  Â  Â  Â  Â  className={`p-4 rounded-full text-white shadow-lg bg-green-600 hover:bg-green-700 transition-transform duration-300 transform ${showFloatingActionMenu ? 'rotate-45' : ''}`}
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  <Plus className="h-6 w-6" />
Â  Â  Â  Â  </button>
Â  Â  Â  Â  {showFloatingActionMenu && (
Â  Â  Â  Â  Â  <div className="absolute bottom-16 left-0 flex flex-col gap-2">
Â  Â  Â  Â  Â  Â  <button onClick={() => setShowProjectModal(true)} className="p-3 rounded-full text-white shadow-md bg-green-500 hover:bg-green-600 transition-colors">
Â  Â  Â  Â  Â  Â  Â  <span className="sr-only">Crear Proyecto</span>
Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button onClick={() => setIsModalOpen(true)} className="p-3 rounded-full text-white shadow-md bg-green-500 hover:bg-green-600 transition-colors">
Â  Â  Â  Â  Â  Â  Â  <span className="sr-only">Crear Tarea</span>
Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="17" x2="12" y2="11"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  )}
Â  Â  Â  </div>

Â  Â  Â  {/* Task Creation Modal */}
Â  Â  Â  {isModalOpen && (
Â  Â  Â  Â  <div className="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 z-[100] backdrop-blur-sm">
Â  Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 rounded-lg p-6 w-full max-w-lg shadow-2xl scale-100 animate-fade-in">
Â  Â  Â  Â  Â  Â  <div className="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  <h3 className="text-xl font-bold text-slate-800 dark:text-slate-100">Crear Nueva Tarea</h3>
Â  Â  Â  Â  Â  Â  Â  <button onClick={closeModal} className="text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">
Â  Â  Â  Â  Â  Â  Â  Â  <X className="h-6 w-6" />
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <form onSubmit={handlePreCreateTask}>
Â  Â  Â  Â  Â  Â  Â  <div className="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <label htmlFor="taskTitle" className="block text-sm font-medium text-slate-700 dark:text-slate-300">TÃ­tulo</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  Â  Â  Â  id="taskTitle"
Â  Â  Â  Â  Â  Â  Â  Â  Â  type="text"
Â  Â  Â  Â  Â  Â  Â  Â  Â  value={newTask.title}
Â  Â  Â  Â  Â  Â  Â  Â  Â  onChange={(e) => setNewTask({ ...newTask, title: e.target.value })}
Â  Â  Â  Â  Â  Â  Â  Â  Â  className="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm p-2 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-100"
Â  Â  Â  Â  Â  Â  Â  Â  Â  required
Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div className="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <label htmlFor="taskDescription" className="block text-sm font-medium text-slate-700 dark:text-slate-300">DescripciÃ³n</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea
Â  Â  Â  Â  Â  Â  Â  Â  Â  id="taskDescription"
Â  Â  Â  Â  Â  Â  Â  Â  Â  value={newTask.description}
Â  Â  Â  Â  Â  Â  Â  Â  Â  onChange={(e) => setNewTask({ ...newTask, description: e.target.value })}
Â  Â  Â  Â  Â  Â  Â  Â  Â  rows="3"
Â  Â  Â  Â  Â  Â  Â  Â  Â  className="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm p-2 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-100"
Â  Â  Â  Â  Â  Â  Â  Â  ></textarea>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div className="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h4 className="text-md font-medium text-slate-700 dark:text-slate-300 mb-2">InformaciÃ³n Adicional</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div className="grid grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  {Object.keys(newTask.infoAdicional).map(key => (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div key={key}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label htmlFor={key} className="block text-xs font-medium text-slate-500 dark:text-slate-400">{key.charAt(0).toUpperCase() + key.slice(1)}</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id={key}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type={key === 'monto' ? 'text' : 'text'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  value={newTask.infoAdicional[key]}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onChange={key === 'monto' ? handleMontoChange : (e) => setNewTask({ ...newTask, infoAdicional: { ...newTask.infoAdicional, [key]: e.target.value } })}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  className="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm p-2 text-sm bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-100"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div className="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <label htmlFor="dueDate" className="block text-sm font-medium text-slate-700 dark:text-slate-300">Fecha de entrega</label>
Â  Â  Â  Â  Â  Â  Â  Â  <div className="flex gap-2 mt-2 flex-wrap">
Â  Â  Â  Â  Â  Â  Â  Â  Â  {dateOptions.map(option => (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  key={option.value}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type="button"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onClick={() => handleDateChange(option.value)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  className="px-3 py-1 text-sm rounded-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {option.label}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  Â  Â  Â  id="dueDate"
Â  Â  Â  Â  Â  Â  Â  Â  Â  type="date"
Â  Â  Â  Â  Â  Â  Â  Â  Â  value={newTask.dueDate}
Â  Â  Â  Â  Â  Â  Â  Â  Â  onChange={handleCustomDateChange}
Â  Â  Â  Â  Â  Â  Â  Â  Â  className="mt-2 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm p-2 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-100"
Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div className="mt-6 flex justify-end gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onClick={closeModal} className="px-4 py-2 rounded-md font-semibold text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" className="px-4 py-2 rounded-md font-semibold text-white bg-green-600 hover:bg-green-700 transition-colors">Crear Tarea</button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  )}

Â  Â  Â  {/* Project Creation Modal */}
Â  Â  Â  {showProjectModal && (
Â  Â  Â  Â  <div className="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 z-[100] backdrop-blur-sm">
Â  Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 rounded-lg p-6 w-full max-w-sm shadow-2xl scale-100 animate-fade-in">
Â  Â  Â  Â  Â  Â  <div className="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  <h3 className="text-xl font-bold text-slate-800 dark:text-slate-100">Crear Nuevo Proyecto</h3>
Â  Â  Â  Â  Â  Â  Â  <button onClick={closeModal} className="text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">
Â  Â  Â  Â  Â  Â  Â  Â  <X className="h-6 w-6" />
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  Â  type="text"
Â  Â  Â  Â  Â  Â  Â  className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-100"
Â  Â  Â  Â  Â  Â  Â  placeholder="Nombre del proyecto"
Â  Â  Â  Â  Â  Â  Â  value={newProjectName}
Â  Â  Â  Â  Â  Â  Â  onChange={(e) => setNewProjectName(e.target.value)}
Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  <div className="mt-4 flex justify-end gap-2">
Â  Â  Â  Â  Â  Â  Â  <button onClick={closeModal} className="px-4 py-2 rounded-md font-semibold text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  <button onClick={handleCreateProject} className="px-4 py-2 rounded-md font-semibold text-white bg-green-600 hover:bg-green-700">Crear</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  )}

Â  Â  Â  {/* Task Detail Modal */}
Â  Â  Â  {isTaskDetailModalOpen && selectedTask && (
Â  Â  Â  Â  <div className="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 z-[100] backdrop-blur-sm">
Â  Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 rounded-lg p-6 w-full max-w-lg shadow-2xl scale-100 animate-fade-in">
Â  Â  Â  Â  Â  Â  <div className="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  <h3 className="text-xl font-bold text-slate-800 dark:text-slate-100">{selectedTask.title}</h3>
Â  Â  Â  Â  Â  Â  Â  <button onClick={closeModal} className="text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">
Â  Â  Â  Â  Â  Â  Â  Â  <X className="h-6 w-6" />
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div className="space-y-4 text-slate-700 dark:text-slate-300">
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <h4 className="font-semibold">DescripciÃ³n:</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <p>{selectedTask.description}</p>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <h4 className="font-semibold">Proyecto:</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <p>{selectedTask.projectName}</p>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <h4 className="font-semibold">Estado:</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <p>{statusMap[selectedTask.status]}</p>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <h4 className="font-semibold">Fecha de Entrega:</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <p>{selectedTask.dueDate ? new Date(selectedTask.dueDate).toLocaleDateString() : 'N/A'}</p>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div className="mt-4">
Â  Â  Â  Â  Â  Â  Â  <h4 className="font-semibold text-slate-800 dark:text-slate-100 mb-2">InformaciÃ³n Adicional:</h4>
Â  Â  Â  Â  Â  Â  Â  <ul className="list-disc list-inside space-y-1 text-slate-700 dark:text-slate-300">
Â  Â  Â  Â  Â  Â  Â  Â  {Object.entries(selectedTask.infoAdicional).map(([key, value]) => (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <li key={key}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span className="font-medium">{key.charAt(0).toUpperCase() + key.slice(1)}:</span> {value}
Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  )}

Â  Â  Â  {/* Update Status Modal */}
Â  Â  Â  {isUpdateModalOpen && taskToUpdate && (
Â  Â  Â  Â  <div className="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 z-[100] backdrop-blur-sm">
Â  Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 rounded-lg p-6 w-full max-w-sm shadow-2xl scale-100 animate-fade-in">
Â  Â  Â  Â  Â  Â  <div className="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  <h3 className="text-xl font-bold text-slate-800 dark:text-slate-100">Actualizar Tarea</h3>
Â  Â  Â  Â  Â  Â  Â  <button onClick={closeModal} className="text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">
Â  Â  Â  Â  Â  Â  Â  Â  <X className="h-6 w-6" />
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p className="text-slate-700 dark:text-slate-300 mb-4">Cambiar estado a: <span className="font-bold">{statusMap[taskToUpdate.newStatus]}</span></p>
Â  Â  Â  Â  Â  Â  <textarea
Â  Â  Â  Â  Â  Â  Â  className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-100"
Â  Â  Â  Â  Â  Â  Â  rows="3"
Â  Â  Â  Â  Â  Â  Â  placeholder="AÃ±adir comentario..."
Â  Â  Â  Â  Â  Â  Â  value={taskUpdateData.comment}
Â  Â  Â  Â  Â  Â  Â  onChange={(e) => setTaskUpdateData({ ...taskUpdateData, comment: e.target.value })}
Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  <div className="mt-4 flex justify-end gap-2">
Â  Â  Â  Â  Â  Â  Â  <button onClick={closeModal} className="px-4 py-2 rounded-md font-semibold text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  <button onClick={handleConfirmUpdate} className="px-4 py-2 rounded-md font-semibold text-white bg-blue-600 hover:bg-blue-700">Confirmar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  )}

Â  Â  Â  {/* Task Confirmation Modal */}
Â  Â  Â  {isConfirmTaskModalOpen && taskToConfirm && (
Â  Â  Â  Â  <div className="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 z-[100] backdrop-blur-sm">
Â  Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 rounded-lg p-6 w-full max-w-sm shadow-2xl scale-100 animate-fade-in">
Â  Â  Â  Â  Â  Â  <div className="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  <h3 className="text-xl font-bold text-slate-800 dark:text-slate-100">Confirmar Tarea</h3>
Â  Â  Â  Â  Â  Â  Â  <button onClick={closeModal} className="text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">
Â  Â  Â  Â  Â  Â  Â  Â  <X className="h-6 w-6" />
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p className="text-slate-700 dark:text-slate-300 mb-4">Â¿EstÃ¡s seguro de que quieres crear la siguiente tarea?</p>
Â  Â  Â  Â  Â  Â  <p className="font-semibold text-slate-800 dark:text-slate-100">{taskToConfirm.title}</p>
Â  Â  Â  Â  Â  Â  <div className="mt-4 flex justify-end gap-2">
Â  Â  Â  Â  Â  Â  Â  <button onClick={closeModal} className="px-4 py-2 rounded-md font-semibold text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  <button onClick={handleConfirmCreateTask} className="px-4 py-2 rounded-md font-semibold text-white bg-green-600 hover:bg-green-700">Confirmar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  )}
Â  Â  Â  
Â  Â  Â  {/* History Audit Modal */}
Â  Â  Â  {historyModalOpen && selectedHistoryItem && (
Â  Â  Â  Â  <div className="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 z-[100] backdrop-blur-sm">
Â  Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 rounded-lg p-6 w-full max-w-lg shadow-2xl scale-100 animate-fade-in">
Â  Â  Â  Â  Â  Â  <div className="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  <h3 className="text-xl font-bold text-slate-800 dark:text-slate-100">AuditorÃ­a de Tarea</h3>
Â  Â  Â  Â  Â  Â  Â  <button onClick={closeModal} className="text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">
Â  Â  Â  Â  Â  Â  Â  Â  <X className="h-6 w-6" />
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <h4 className="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-2">"{selectedHistoryItem.taskTitle}"</h4>
Â  Â  Â  Â  Â  Â  <div className="space-y-4 max-h-96 overflow-y-auto pr-2">
Â  Â  Â  Â  Â  Â  Â  {selectedHistoryItem.fullHistory.length > 0 ? (
Â  Â  Â  Â  Â  Â  Â  Â  selectedHistoryItem.fullHistory.map((entry, index) => (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div key={index} className="p-4 bg-slate-50 dark:bg-slate-700 rounded-lg shadow-inner">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="flex items-center gap-2 mb-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span className="text-xs font-medium text-white bg-slate-500 rounded-full px-2 py-1">{statusMap[entry.status]}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span className="text-xs text-slate-500 dark:text-slate-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {entry.timestamp instanceof Date ? entry.timestamp.toLocaleString() : new Date(entry.timestamp.seconds * 1000).toLocaleString()}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p className="text-sm text-slate-700 dark:text-slate-300">{entry.change}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {entry.comment && <p className="text-sm italic text-slate-500 dark:text-slate-400 mt-1">"{entry.comment}"</p>}
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ))
Â  Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  Â  <p className="text-slate-500 dark:text-slate-400">No hay historial para esta tarea.</p>
Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  )}

Â  Â  Â  {/* User Info Modal */}
Â  Â  Â  {showUserInfoModal && (
Â  Â  Â  Â  <div className="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 z-[100] backdrop-blur-sm">
Â  Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 rounded-lg p-6 w-full max-w-sm shadow-2xl scale-100 animate-fade-in">
Â  Â  Â  Â  Â  Â  <div className="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  <h3 className="text-xl font-bold text-slate-800 dark:text-slate-100">InformaciÃ³n de Usuario</h3>
Â  Â  Â  Â  Â  Â  Â  <button onClick={closeModal} className="text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">
Â  Â  Â  Â  Â  Â  Â  Â  <X className="h-6 w-6" />
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div className="text-center mb-4">
Â  Â  Â  Â  Â  Â  Â  <p className="text-slate-700 dark:text-slate-300">ID de Usuario: <code className="break-all font-mono bg-slate-200 dark:bg-slate-700 rounded p-1">{userId}</code></p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div className="flex flex-col items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  <div className="w-24 h-24 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-5xl">
Â  Â  Â  Â  Â  Â  Â  Â  {userAvatar}
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div className="flex flex-wrap gap-2 justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  {defaultEmojis.map(emoji => (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button key={emoji} onClick={() => handleUpdateAvatar(emoji)} className="p-2 rounded-full text-2xl bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {emoji}
Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <input type="file" onChange={handleFileChange} className="mt-4 text-sm text-slate-500 dark:text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  )}

Â  Â  Â  {/* Asistente de BÃºsqueda Modal */}
Â  Â  Â  {isAssistantModalOpen && (
Â  Â  Â  Â  <div className="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 z-[100] backdrop-blur-sm">
Â  Â  Â  Â  Â  <div className="bg-white dark:bg-slate-800 rounded-lg p-6 w-full max-w-xl shadow-2xl scale-100 animate-fade-in flex flex-col h-full max-h-[80vh]">
Â  Â  Â  Â  Â  Â  <div className="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  <h3 className="text-xl font-bold text-slate-800 dark:text-slate-100 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  <Search className="h-6 w-6 mr-2 text-sky-600" /> Asistente de BÃºsqueda
Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  <button onClick={closeModal} className="text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">
Â  Â  Â  Â  Â  Â  Â  Â  <X className="h-6 w-6" />
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div className="flex-grow overflow-y-auto border-t border-b border-slate-200 dark:border-slate-700 py-4 mb-4 space-y-4">
Â  Â  Â  Â  Â  Â  Â  {chatHistory.length === 0 && (
Â  Â  Â  Â  Â  Â  Â  Â  <div className="text-center text-slate-500 dark:text-slate-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Escribe una pregunta sobre tus proyectos o tareas.
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  {chatHistory.map((msg, index) => (
Â  Â  Â  Â  Â  Â  Â  Â  <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className={`max-w-[80%] p-3 rounded-lg ${msg.role === 'user' ? 'bg-blue-500 text-white' : 'bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100'}`}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p className="whitespace-pre-wrap">{msg.text}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  Â  {isAssistantLoading && (
Â  Â  Â  Â  Â  Â  Â  Â  <div className="flex justify-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div className="p-3 rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p className="animate-pulse">Escribiendo...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  <div ref={responseRef}></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <form onSubmit={handleAssistantSearch} className="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  Â  Â  type="text"
Â  Â  Â  Â  Â  Â  Â  Â  value={assistantQuery}
Â  Â  Â  Â  Â  Â  Â  Â  onChange={(e) => setAssistantQuery(e.target.value)}
Â  Â  Â  Â  Â  Â  Â  Â  className="flex-grow p-3 rounded-md border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-600"
Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Pregunta sobre tus tareas..."
Â  Â  Â  Â  Â  Â  Â  Â  disabled={isAssistantLoading}
Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  <button type="submit" disabled={isAssistantLoading} className="p-3 rounded-md text-white bg-sky-600 hover:bg-sky-700 disabled:bg-slate-400 transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  <CornerDownLeft className="h-6 w-6" />
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  )}

Â  Â  </div>
Â  );
}

export default App;
